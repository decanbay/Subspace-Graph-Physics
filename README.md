# Subspace Graph Physics: <br /> Real-Time Rigid Body-Driven Granular Flow Simulation

This is a computationally efficient version of "Learning To Simulate" developed by [DeepMind and Stanford](https://github.com/deepmind/deepmind-research/tree/master/learning_to_simulate) for real-time physics simulation, specially granular flows and their interactions with rigid bodies. The approach is developed under the supervision of [Prof. K. Skonieczny (Concordia)](http://users.encs.concordia.ca/~kskoniec/).

* We train the graph network (GN) model in subspace by performing Principal Component Analysis (PCA).

* PCA enables GN to be trained using a single desktop GPU with moderate VRAM for large 3D configurations.

* The training datasets can be generated by our efficient and accurate [Material Point Method](https://github.com/haeriamin/MPM-NGF) (MPM).

* The rollout runtime is 5 micro-sec/sec, and the training runtime is 40 global-step/sec (on NVIDIA RTX 3080).

The particle positions and velocities, and rigid body interaction forces are compared below:

<img src="https://github.com/haeriamin/files/blob/master/excav_ml_4.gif" alt="drawing" width="820">


<!-- ## Code structure

* `run.py`: Runs the optimization.

    * The initial, lower and upper bounds of optimization variables are defined here.
        ```python
        X0 = [,]
        LB = [,]
        UB = [,]
        ```

    * Some other settings including loading/saving optimal solution, and excavation depth and time can also be set.
        ```python
        load = True/False
        save = True/False
        depths = [,]  # [m]
        sim_times = [,]  # [sec]
        ```


* `constr_nm.py`: Implements the constrained Nelder-Mead method [(reference)](https://github.com/alexblaessle/constrNMPy).

* `nelder_mead.py`: Implements the Nelder-Mead method [(reference)](https://github.com/scipy/scipy/blob/master/scipy/optimize/optimize.py).

    * This is modified to terminate the optimization loop when no significant error changes happen (e.g. `<1`%) during the last specified iterations by setting e.g. `history = 10` as fallows:

        ```python
        if iterations > history+2:
            for i in range(2,history+2):
                fval_sum += abs(fval_history[-1] - fval_history[-i])
            if fval_sum/history < 1:
                break
        ```

* `obj_func.py`: Implements the objective function.

    * The Vortex (excavation) model is called here and implemented in:

        ```python
        def run_vortex(self, x, depth):
            ...
        ```

    * The mean absolute percentage error (MAPE) is calculated using the results from Vortex and experiment.

    * The Vortex files and reference (experimental) results should already be provided in folder `input/`.


## Requirements

* VxSim
* numpy
* pickle -->

# Bibtex
While we are preparing our journal paper, please cite our conference [paper](https://ieeexplore.ieee.org/abstract/document/9438132) if you use this code for your research: 
```
@INPROCEEDINGS{9438132,
    author={Haeri, A. and Skonieczny, K.},
    booktitle={2021 IEEE Aerospace Conference (50100)},
    title={Accurate and Real-time Simulation of Rover Wheel Traction},
    year={2021},
    volume={},
    number={},
    pages={1-9},
    doi={10.1109/AERO50100.2021.9438132}
}
```